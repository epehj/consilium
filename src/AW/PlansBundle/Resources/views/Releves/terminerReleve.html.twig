{% extends "AWCoreBundle::layout.html.twig" %}

{% block title %}{{ commande.ref }} :: {{ parent() }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    <link rel="stylesheet" href="{{ asset('bundles/awplans/css/plans.css') }}">
{% endblock %}


{% block content %}
    {{ form_start(form) }}
<div class="row">
  <div class="col-xs-12 col-md-10 col-md-offset-1">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Commande {{ commande.ref }}</h3>
      </div>
      <div class="panel-body">
          <div class="panel panel-default">
              <div class="panel-heading">Relevé OK</div>
              <div class="panel-body">
                  {{ form_row(form.commande.releveur)}}
                  <input type="text" value="TODO ajouter des releves">
                  {{ form_row(form.validationObligatoireByReleveur)}}
                  {{ form_row(form.remarques) }}
              </div>

              <div class="panel-heading">Anomalies</div>
              <div class="panel-body">
                  {{ form_row(form.anomalies)}}
                  {{ form_row(form.remarqueAno)}}
{#                  TODO ajouter event : quand click sur btn RDV, selectionner ano «prise de rdv»#}
                  {% if is_granted('ADD_RELEVE', commande) %}
                      <div class="row">
                          <div class="col-md-offset-2">
                            <a href="{{ path('aw_plans_releves_add_rdv', {id: commande.id}) }}" class="btn btn-success">Noter le rendez-vous</a>
                          </div>
                      </div>
                  {% endif %}
              </div>

              <div class="panel-heading">Commande à annuler</div>
              <div class="panel-body">
                  {{ form_row(form.cancel)}}
                  {{ form_row(form.remarqueCancel)}}
              </div>

              <div class="panel-heading">Modifications</div>
              <div class="panel-body">
                  <div class="row">
                      <div class="col-md-4">
                          {{ form_row(form.commande.address1, {attr: {autocomplete: 'off', class: 'typeahead'}}) }}
                          {% if commande.address2 is not null and commande.address2 is not empty %}
                          {{ form_row(form.commande.address2) }}
                          {% endif %}
                      </div>
                      <div class="col-md-4">
                          {{ form_row(form.commande.zip) }}
                      </div>
                      <div class="col-md-4">
                          {{ form_row(form.commande.town) }}
                      </div>
                      </div>
                      <div class="col-md-4">
                          {{ form_row(form.commande.contactBatName) }}
                      </div>
                      <div class="col-md-4">
                          {{ form_row(form.acces) }}
                      </div>
                      <div class="col-md-4">
                          {{ form_row(form.typeBatiment)}}
                      </div>
{#                  TODO ajouter l'upload de logo si besoin#}
              </div>
              {% include "AWPlansBundle:Default:plans.html.twig" %}

          </div>
      <div class="row">
        <a href="{{ path('aw_plans_releves_view', {id: commande.id}) }}" class="btn btn-default">Annuler</a>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>

      </div>
    </div>
  </div>
</div>
{#    {{ form_rest(form) }}#}
    {{ form_row(form._token) }}
    {{ form_end(form, {'render_rest': false}) }}


{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="{{ asset('libs/bootstrap-datepicker/js/bootstrap-datepicker.min.js') }}"></script>
<script src="{{ asset('libs/bootstrap-datepicker/locales/bootstrap-datepicker.fr.min.js') }}"></script>
<script>
$(function(){
  $('#aw_plansbundle_commande_releve_note_date_date').datepicker({
    autoclose: true,
    calendarWeeks: true,
    format: 'dd-mm-yyyy',
    language: 'fr'
  })
    .on('changeDate', function(e){
      var d = e.date;
      var DoW = d.getDay();
      d.setDate(d.getDate() - (DoW + 6) % 7 + 3); // Nearest Thu
      var ms = d.valueOf(); // GMT
      d.setMonth(0);
      d.setDate(4); // Thu in Week 1
      DoW = Math.round((ms - d.valueOf()) / (7 * 864e5)) + 1;

      $('#aw_plansbundle_commande_releve_note_releveNote').val('RDV semaine '+DoW);
    })
  ;
});
</script>
{% endblock %}
